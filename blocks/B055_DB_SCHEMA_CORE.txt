vpn_masterkonzept/blocks/B055_DB_SCHEMA_CORE.txt
================================================================================
BLOCK-ID: B055
TITLE: DB Schema Core (customers, vpn_connections, active_session_locks)
VERSION: v1.2
STATUS: ACTIVE
PRIORITY: MUST
OWNER-INTENT: Verbindliches SQL-first Schema als Single Source of Truth (Stabilität + deterministische State-Machine für Claim/SimUse/Restricted).
================================================================================

================================================================================
1) INHALT
================================================================================

## 1) Purpose
Define core DB schema for:
- customers (panel account)
- vpn_connections (device/subaccount)
- active_session_locks (atomic SimUse guard)
- plus minimal indices required for high-performance reconcile

## 2) Core Tables

### 2.1 customers
- id (PK)
- email (UNIQUE)
- password_hash (Argon2id)
- created_at
- status (active/suspended/deleted)
- (panel-only meta)

Indexes:
- UNIQUE(email)

### 2.2 vpn_connections (pro Gerät / VPN-Client / Subaccount)
- id (PK)
- customer_id (FK, NULL bis Claim)
- subaccount_login (PPP/RADIUS Username; pro Gerät; UNIQUE)
- subaccount_nt_hash (MSCHAPv2 Secret als NT-Hash; SoT; kein Klartext-SoT)
- fixed_ip (IPv4; PPP-IP; RADIUS Framed-IP-Address; fix pro Connection)
- status (ENUM: PREPROVISIONED | CLAIMED | DISABLED)
- claim_token_hash (UNIQUE) <-- Hash des Claim-Tokens (claim_token Klartext existiert nur auf Gerät/Sticker/Label; NIE für VPN-Login)
- claimed_at (timestamp, NULL bis Claim)
- unclaimed_grace_until (timestamp) <-- bis dahin FULL, danach UNCLAIMED_OVERDUE -> restricted
- claim_deadline (timestamp) <-- Hard-Stop: Default created_at + 180d (Claim möglich bis dahin, danach DISABLED)
- created_at
- updated_at

Indices:
- UNIQUE(subaccount_login)
- UNIQUE(claim_token_hash)
- INDEX status
- INDEX customer_id
- INDEX fixed_ip
- INDEX unclaimed_grace_until
- INDEX claim_deadline

### 2.3 active_session_locks  <-- FIX REQUIRED
Atomic guard against SimUse race (radacct is history, not a lock)
- id (PK)
- vpn_connection_id (FK vpn_connections.id)
- session_key (VARCHAR)  <-- derived from NAS-IP-Address + Calling-Station-Id + username
- acquired_at (DATETIME)
- expires_at (DATETIME)
- state (enum: held, released)
- release_reason (nullable)

Constraints:
- UNIQUE(vpn_connection_id)  <-- SimUse=1 guard
- INDEX(expires_at)          <-- janitor scans

## 3) Notes / Constraints
- vpn_connections.restricted_effective is the performance field (avoid join-heavy evaluate path).
- active_session_locks must be used by T02 mapping + T09 tests.

================================================================================
3) CHANGELOG
================================================================================
- v1.2 (2026-01-09): vpn_connections Feldnamen/SoT vereinheitlicht: token -> claim_token_hash; subaccount_secret -> subaccount_nt_hash; Pflichtfelder (subaccount_login, fixed_ip, claim_deadline) im Schema-Block ergänzt; Indizes angepasst.
- v1.1 (2026-01-08): vpn_connections Schema an v2.1.1 State-Machine angepasst (status PREPROVISIONED/CLAIMED/DISABLED, claim_deadline MUST 180d, Grace/Deadline timestamps, restricted_reason ENUM). Terminologie bereinigt (keine Gates).
- v1.0 (2026-01-07): Neu angelegt. Inhalt aus T01_DB_SCHEMA_CORE (v0.7) in Block-Form übernommen (ohne inhaltliche Änderung).
================================================================================
END BLOCK B055
================================================================================