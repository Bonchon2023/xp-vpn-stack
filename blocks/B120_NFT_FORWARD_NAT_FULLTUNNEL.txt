vpn_masterkonzept/blocks/B120_NFT_FORWARD_NAT_FULLTUNNEL.txt
================================================================================
BLOCK-ID: B120
TITLE: nftables Forward + NAT (Full-Tunnel)
VERSION: v1.1
STATUS: ACTIVE
PRIORITY: MUST
OWNER-INTENT: Full-Tunnel Routing/NAT sauber und deterministisch.
================================================================================

1) ZWECK
- Erlaubt VPN subnets -> WAN und NAT.

2) GRENZEN
- Kein Forward zwischen User-Clients (handled in B130).
- Restricted Mode (B150) kann Forward zusätzlich reduzieren (Portal-Only).
- Wichtig: Restricted Enforcement (B150) muss im forward chain vor dem allgemeinen Forward-Allow (dieser Block) evaluiert werden (sonst Umgehung möglich).
- Konkret: Für saddr∈restricted_v4 (B150) ist im forward chain nur Verkehr zu 10.77.0.1 erlaubt:
  - DNS: 53/udp + 53/tcp
  - Web/Portal: 80/tcp + 443/tcp
  - NTP: 123/udp
  - ICMP echo zu 10.77.0.1 (Diagnose)
  - Alles andere (insb. Forward->ens13) muss droppen.
- DNS-Enforcement (B210): DNAT für 53/udp + 53/tcp auf 10.77.0.1 muss in nft nat prerouting auf iifname "ppp*" greifen (vor filter/forward), damit Clients keinen externen DNS nutzen können.

3) ABHÄNGIGKEITEN
- Requires: B060, B100
- Influences: B130, B140, B150, B210

4) INPUTS
- VPN source ranges
- WAN: ens13
- ppp interfaces

5) OUTPUTS
- forward allow:
  - 10.77.10.0/24 -> ens13
  - 10.77.20.0/24 -> ens13
- conntrack allow for return traffic
- NAT masquerade both nets out ens13

6) MUST
- Full-tunnel works: default route on clients points to PPP
- NAT correct

7) OPTIONEN
- Separate NAT policies per subnet if needed later.

8) FEHLERBILDER
- No internet: forward or nat missing
- Only some sites: MSS clamp missing

9) TESTS
- From client: traceroute shows server exit.
- IP check: public IP = server IP.

10) CHANGELOG
-    v1.1:     Restricted Mode Reihenfolge + konkrete Allowlist (DNS udp+tcp 53, Web 80/443, NTP 123/udp, ICMP zu 10.77.0.1) ergänzt; Hinweis zu DNS-Enforcement Hook/Order (B210) ergänzt.
- v1.0: Initial

================================================================================