vpn_masterkonzept/blocks/B310_TESTS_ACCEPTANCE_CATALOG.txt
================================================================================
BLOCK-ID: B310
TITLE: Tests / Acceptance Criteria (E2E-Katalog)
VERSION: v1.4
STATUS: ACTIVE
PRIORITY: MUST
OWNER-INTENT: Abnahmekatalog für Stabilität (SimUse, DNS, /diag, Webstack, MTU/MSS/Offload) — messbar, reproduzierbar.
================================================================================

================================================================================
1) SIMUSE + STALE SESSIONS
================================================================================

## 1) SimUse atomic guard tests
- Two parallel logins for same vpn_connection_id / subaccount_login (AAA identity; claim_token is claim-only):
  - Expect exactly one ACCEPT, one REJECT/TEMPFAIL (policy-defined)
- Lock row exists in active_session_locks after ACCEPT
- Lock released on Accounting-Stop
- Lock expires by janitor after expires_at

## 1.1) Connect Gate (D1a) – No Unpoliced Window
- Setup: In ip-up oder vpn-policy-apply künstlichen Delay einbauen (sleep 10).
- Erwartung: Während connect_pending_v4 aktiv ist, ist Forward-Traffic (WAN) 0.
- Erwartung: Nach SUCCESS wird Gate entfernt und Policy gilt (restricted/full).
- Negativtest: policy-apply TEMPFAIL_SQL/Timeout -> PPP wird gekillt, Gate bleibt bis Cleanup, kein Leak.

## 2) Stale sessions tests
- Simulate missing Accounting-Stop:
  - Lock expires -> next login succeeds
- Janitor clears stale radacct entries and stale locks deterministically

## 3) E2E validation
- Run 50 parallel connect attempts:
  - No double-ACCEPT for same vpn_connection
  - No DB deadlocks
  - Mean time stable

## 4) ONBOARDING / VERIFY-WALL / CLAIM (SECURITY-CRITICAL E2E)
- PENDING Customer (email_verified_at NULL):
  - Panel erlaubt nur /verify + /verify/resend (kein Zugriff auf Connections/Actions).
  - /claim muss abgewiesen werden (Customer nicht ACTIVE).
- ACTIVE Customer (email_verified_at gesetzt):
  - Claim mit korrekt eingegebenem claim_token (Server prüft gegen claim_token_hash) funktioniert.
  - Wrong-Token Versuche sind rate-limited; kein Enumeration-Leak (gleiche Fehlermeldung für „nicht existent“ vs „falsch“).
- First-Claim IP-Bind:
  - Request VPN-IP muss == fixed_ip der Ziel-Connection sein, sonst Claim fail.
- UNCLAIMED_GRACE / UNCLAIMED_OVERDUE:
  - Nach Ablauf unclaimed_grace_until: Internet gesperrt (restricted), Panel/Verify/Claim bleibt erreichbar.
  - Claim innerhalb claim_deadline hebt UNCLAIMED_OVERDUE sofort auf (restricted entfernt, sofern kein anderer Grund).
- Hard-Stop:
  - Nach claim_deadline: Connection wird DISABLED; RADIUS reject; Claim muss fehlschlagen (Hard Stop).

================================================================================
2) DNS FAILURE MODES + HEALTHCHECKS
================================================================================

## 1) Failure modes
- AdGuard down -> what happens?
- Unbound down -> what happens?
- Upstream DNS failure -> what happens?

## 2) Healthchecks
- local resolver health probe
- panel shows degraded state
- enforcement still forces port 53 to service IP

================================================================================
3) /diag SPEZIFIKATION + TESTS
================================================================================

## 1) Endpoint
- GET /diag returns JSON with:
  - vpn stack health
  - dns health
  - radius health
  - nftables rules present
  - tc qdisc state

## 2) Security
- Only accessible inside VPN/admin scope
- No sensitive secrets returned

## 3) Tests
- /diag returns 200 when healthy
- /diag returns degraded with clear reason codes

================================================================================
4) WEBSTACK HARDENING / INTERNAL-ONLY TESTS
================================================================================

## 1) Binding scope
- OpenResty only listens on service-IP and/or VPN nets
- No WAN port open except VPN ports

## 2) Tests
- Port scan from WAN: no panel ports reachable
- From admin net: panel reachable

================================================================================
5) MTU/MSS/OFFLOAD DEFAULTS + TESTS
================================================================================

## 1) MTU/MSS tests
- Verify no PMTU blackhole
- MSS clamp effective on PPP interfaces

## 2) Offload defaults
- Default offload settings applied
- Validate no checksum issues

================================================================================
6) CHANGELOG
================================================================================
- v1.3 (2026-01-09): Security-kritische E2E Tests ergänzt: Verify-Wall/Claim/IP-Bind/UNCLAIMED_OVERDUE/claim_deadline Hard-Stop.
- v1.2 (2026-01-09): Terminologie-Regel umgesetzt: unqualifiziertes „token“ im SimUse-Testtext zu „claim_token“ präzisiert.
- v1.1 (2026-01-09): Test-Semantik korrigiert: SimUse bezieht sich auf vpn_connection_id/subaccount_login (AAA). Klarstellung: token ist Claim-only und kein Login-Credential.
- v1.0 (2026-01-07): Neu angelegt. T09–T13 in einen Block konsolidiert (ohne inhaltliche Änderungen, nur Bündelung).
================================================================================
END BLOCK B310
================================================================================