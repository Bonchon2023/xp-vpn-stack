vpn_masterkonzept/blocks/B056_RADIUS_SCHEMA_MAPPING.txt
================================================================================
BLOCK-ID: B056
TITLE: RADIUS SQL Schema + Mapping + SimUse-Atomic Lock Lifecycle
VERSION: v1.2
STATUS: ACTIVE
PRIORITY: MUST
OWNER-INTENT: Verbindliches Mapping zwischen Core-DB (B055) und FreeRADIUS SQL (radcheck/radreply/radacct) inkl. atomarem Session-Lock gegen SimUse-Races.
================================================================================

================================================================================
1) INHALT (Token=Claim-only; AAA via MSCHAPv2 + NT-Hash)
================================================================================

Priority: MUST

## 1) Goal
Map vpn_connections to FreeRADIUS SQL users (subaccount_login model) and ensure atomic SimUse protection using active_session_locks.
Claim-Tokens (claim_token/claim_token_hash) are App-Layer only and MUST NOT be used for PPP/RADIUS auth.

## 2) Identity Model
- VPN client connects using subaccount_login (User-Name) + password (validated via subaccount_nt_hash / RADIUS NT-Password; MSCHAPv2). No manual input needed on XP because the client profile is preconfigured.
- FreeRADIUS receives User-Name = subaccount_login and validates MSCHAPv2 against NT-Hash (NT-Password) from SQL backend.
- IPsec PSK is an IPsec-layer secret and is NOT part of RADIUS/PPP credential mapping.

## 3) radcheck / radreply model
- radcheck:
  - store subaccount_login as username
  - store user's NT-Hash as NT-Password (for MSCHAPv2)
- radreply:
  - push Framed-IP-Address (optional static), Framed-Route, DNS (if used), etc.

## 4) Atomic SimUse guard (FIX REQUIRED)
- On Access-Request, before ACCEPT:
  - Try INSERT into active_session_locks(vpn_connection_id, session_key, acquired_at, expires_at, state)
  - If UNIQUE constraint hit: reject or TEMPFAIL based on policy
- On Accounting-Stop:
  - Mark lock released, set release_reason
- Janitor:
  - Expire locks past expires_at

## 5) Notes
- radacct is not a lock; treat as history.
- Simultaneous-Use is insufficient alone; use DB lock table.

================================================================================
3) CHANGELOG
================================================================================
- v1.2 (2026-01-09): Terminologie-Fix: subaccount_secret entfernt, kanonisch subaccount_nt_hash/NT-Password (MSCHAPv2). Redaktion: doppelte Überschrift „2) 2)“ korrigiert.
- v1.1 (2026-01-09): Semantik-Fix: Token=Claim-only. RADIUS/PPP Auth via subaccount_login + MSCHAPv2 (NT-Password/NT-Hash). Hinweis auf IPsec-PSK als separater Layer. Abschnitts-Header „unverändert“ korrigiert.
- v1.0 (2026-01-07): Neu angelegt. Inhalt aus T02_RADIUS_SCHEMA_MAPPING in Block-Form übernommen (ohne inhaltliche Änderung).
================================================================================
END BLOCK B056
================================================================================