================================================================================
T91_REASON_CODE_MATRIX_DENY_RESTRICT_OK.txt
Version: v0.1.0 (ENTWURF)
Status: ENTWURF (für Drittprüfung / Spezifikation, kein Code)
================================================================================

## 1) Zweck
Diese Datei ist die “Reason-Code Matrix” als leicht prüfbares Spezifikations-Artefakt:
- klare Trennung: DENY (Reject) vs RESTRICT (Accept/Walled Garden) vs OK
- deterministische Prioritätenkette (welcher Reason gewinnt, wenn mehrere zutreffen)
- kurze, eindeutige Bedeutungen (Support/Observability)
- keine Fail2ban-Logik hier (nur Policy/Outcome Reasons)

## 2) Grundregeln (MUST)
- OUTCOME=DENY     => Access-Reject, Tunnel wird NICHT aufgebaut.
- OUTCOME=RESTRICT => Access-Accept, Tunnel steht, aber Walled Garden/Restricted Mode aktiv.
- OUTCOME=OK       => Access-Accept, Full Tunnel aktiv.

- Priorität ist deterministisch:
  0 Backend Failure > 1 Hard Admin > 2 Security/Operational > 3 Self-Service > 4 OK

- R_AUTH_* sind Auth/Infra-Reasons (nicht “User-Policy”), aber werden im gleichen Matrix-Format geführt.
- POLICY_DENY (z.B. banned/disabled) darf niemals Fail2ban triggern (NAT-Safety).
- BACKEND_ERROR (SQL down) darf niemals Fail2ban triggern (D1a).

## 3) Reason-Code Matrix (FINAL ENTWURF)

Legende:
- Prio: 0 = sticht alles
- Outcome: DENY / RESTRICT / OK
- Kurz: 1-liner für Support
- Notes: wichtige Klarstellungen / Erwartungen an UX/Walled Garden

================================================================================
PRIO 0 — BACKEND / INFRA (sticht alles)
================================================================================
R_AUTH_BACKEND_SQL_DOWN
- Outcome: DENY
- Kurz: SQL/Backend nicht verfügbar → Fail-Closed Reject (D1a)
- Notes: KEIN Fail2ban-Ban; keine Self-Service Pfade; “VPN ist temporär nicht verfügbar”.

R_AUTH_BACKEND_SQL_ERROR
- Outcome: DENY
- Kurz: SQL Query/Pool/Timeout/Conn refused → Reject
- Notes: wie SQL_DOWN, nur granularer.

================================================================================
PRIO 1 — HARD ADMIN (DENY)
================================================================================
R_ACCOUNT_BANNED
- Outcome: DENY
- Kurz: Account permanent gebannt (Hard Ban)
- Notes: kein Tunnel, kein Panel, kein Walled Garden.

R_ABUSE_HOLD
- Outcome: DENY
- Kurz: Abuse-Hold aktiv (manuelle/automatische Sperre)
- Notes: kein Tunnel.

R_ACCOUNT_DISABLED
- Outcome: DENY
- Kurz: Account deaktiviert (Admin)
- Notes: kein Tunnel.

R_ACCOUNT_LOCKED_ADMIN
- Outcome: DENY
- Kurz: Account gesperrt (Admin Lock, z.B. Investigation)
- Notes: kein Tunnel.

================================================================================
PRIO 2 — SECURITY / OPERATIONAL VIOLATIONS (DENY)
================================================================================
R_CLAIM_IP_MISMATCH
- Outcome: DENY
- Kurz: Claim/Bind-IP stimmt nicht → Security Reject
- Notes: gilt als Angriff/Violation, kein Self-Service.

R_CLIENT_NOT_ASSIGNED
- Outcome: DENY
- Kurz: VPN-Client/Subaccount nicht diesem Panel-User zugeordnet
- Notes: Security Reject.

R_SIMUSE_ACTIVE
- Outcome: DENY
- Kurz: Simultaneous-Use Schutz aktiv (Lock lebt) → Reject
- Notes: Takeover nur wenn stale/pending_ttl überschritten (separate SimUse Spec).

R_RATE_LIMITED_RADIUS
- Outcome: DENY
- Kurz: RADIUS Rate-Limit greift (Schutz gegen Stuffing/Bruteforce)
- Notes: temporär; NAT-safety beachten.

R_REGION_BLOCKED
- Outcome: DENY
- Kurz: Region/Geo block (falls aktiviert)
- Notes: optionales Feature; nur wenn bewusst gewollt.

R_ADMIN_ONLY_SCOPE
- Outcome: DENY
- Kurz: Nur Admin-VPN/Scope erlaubt (User in falschem Scope)
- Notes: optional.

================================================================================
PRIO 3 — SELF-SERVICE STATES (RESTRICT / WALLED GARDEN)
================================================================================
R_ACCOUNT_NOT_VERIFIED
- Outcome: RESTRICT
- Kurz: E-Mail nicht verifiziert → Walled Garden (Verify Wall)
- Notes: User MUSS 10.77.0.1 erreichen können (Panel/Verify).

R_VERIFY_WALL_PENDING
- Outcome: RESTRICT
- Kurz: Verify-Wall aktiv/pending (z.B. Code ausstehend)
- Notes: funktional identisch zu NOT_VERIFIED; Reihenfolge egal.

R_CLAIM_REQUIRED
- Outcome: RESTRICT
- Kurz: Client/Device noch nicht geclaimt → Walled Garden (Claim UI)
- Notes: User braucht Panel-Zugriff (Token eingeben, Claim durchführen).

R_ACCOUNT_EXPIRED
- Outcome: RESTRICT
- Kurz: Vertrag/Subscription abgelaufen → Renew im Panel
- Notes: ausdrücklich RESTRICT (nicht DENY), damit Renew möglich ist.

R_QUOTA_EXCEEDED
- Outcome: RESTRICT
- Kurz: Volumen/Quota leer → Top-up/Status im Panel
- Notes: ausdrücklich RESTRICT (nicht DENY), damit Self-Service funktioniert.

================================================================================
PRIO 4 — SUCCESS (OK)
================================================================================
R_OK
- Outcome: OK
- Kurz: Full Tunnel erlaubt
- Notes: normale Nutzung.

## 4) Support/Observability: empfohlene “Human Message” Mapping (OPTIONAL)
Hinweis: Diese Texte sind NUR als “Operator Notes” gedacht (kein UX final).
- R_ACCOUNT_BANNED       -> "Zugang gesperrt. Bitte Support kontaktieren."
- R_ACCOUNT_NOT_VERIFIED -> "Bitte E-Mail verifizieren (Panel)."
- R_CLAIM_REQUIRED       -> "Bitte Gerät/Client im Panel claimen."
- R_QUOTA_EXCEEDED       -> "Volumen leer. Bitte im Panel nachladen."
- R_AUTH_BACKEND_SQL_DOWN-> "Dienst vorübergehend nicht verfügbar."

## 5) Konsistenz-Checks (MUST)
C1: Kein Reason aus Prio 3 darf DENY sein (sonst bricht Self-Service).
C2: Prio 0 sticht immer (SQL down => DENY).
C3: BANNED/DISABLED/LOCKED bleiben DENY (Hard Admin).
C4: QUOTA/EXPIRED/VERIFY/CLAIM_REQUIRED bleiben RESTRICT.
C5: Security Violations bleiben DENY.

## 6) Entfernte / Deprecated Aspekte
- (keine in v0.1.0)

## 7) Fehlerbilder & Diagnose (kurz)
- Symptom: Nutzer “kommt nicht rein”
  -> Prüfe: letzte F2B_EVENT / POLICY log line
  -> Expected: Reason-Code + Outcome zeigt sofort Kategorie:
     - DENY/Prio0: Backend
     - DENY/Prio1: Admin Ban
     - DENY/Prio2: Security
     - RESTRICT: Self-Service (Panel erreichbar)
     - OK: Problem liegt außerhalb Policy

================================================================================
Changelog:
- v0.1.0 (ENTWURF): Reason-Code Matrix (DENY/RESTRICT/OK) inkl. Prioritätenkette.
================================================================================