================================================================================
T01_FAIL2BAN_RADIUS_EVENT_CLASSIFICATION.txt
Version: ENTWURF v0.3
Status: ENTWURF (Phase 3) – bereit für Drittprüfung
================================================================================

## 1) Ziel / Zweck
Wir definieren eine stabile, maschinenlesbare Event-Klassifikation für FreeRADIUS-REJECTs,
damit Fail2ban NICHT FreeRADIUS-Debug-Logs parsen muss, sondern nur eine dedizierte Logzeile.

Sicherheitsziele:
- NAT-Safety: UNKNOWN-USER streng bannen; KNOWN_BADPASS nur heavy-only bannen.
- D1a-Kompatibilität: SQL down => REJECT, aber KEINE Mass-Bans legitimer Reconnects.
- Robustheit: Logformat unabhängig von FreeRADIUS-Versionen / Modul-Texten.

## 2) Scope
Betrifft nur den RADIUS Auth-Pfad für L2TP/PPP (pppd -> radius -> FreeRADIUS).
IKE/strongSwan Fail2ban ist separat.

## 3) Begriffe / Klassen
Wir erzeugen exakt diese Klassen:

MUST:
- UNKNOWN_USER    : SQL Query ok, aber User nicht vorhanden (NOTFOUND).
- KNOWN_BADPASS   : User existiert (KNOWN) + MSCHAP Auth scheitert (Wrong pass).
- BACKEND_ERROR   : SQL Query FAIL (DB down/timeout/etc). Fail2ban MUSS ignorieren.
OPTIONAL (aber empfohlen):
- POLICY_DENY     : User existiert, aber Policy verweigert (disabled/expired/verifywall/etc).
Optional (Log-only, not bannable):
- POLICY_RESTRICT: Access-Accept + Walled Garden (Self-Service Zustände; kein Ban, aber Observability).
  Beispiele: NOT_VERIFIED / VERIFY_WALL_PENDING / CLAIM_REQUIRED / EXPIRED / QUOTA_EXCEEDED.
                   Fail2ban ignoriert standardmäßig.
Decision (Final):
- POLICY_DENY: YES (log-only, Fail2ban ignores; used for observability/support).

### 3.2 Reason-Codes (R_*)

**MUST:** Jede F2B_EVENT Logline hat genau **einen** kanonischen `Reason=` Code.

**Auth-Reasons (R_AUTH_*)** — gelten nur für die drei Auth-/Backend-Klassen:
- `Class=UNKNOWN_USER`  => `Reason=R_AUTH_UNKNOWN_USER`
- `Class=KNOWN_BADPASS` => `Reason=R_AUTH_KNOWN_BADPASS`
- `Class=BACKEND_ERROR` => `Reason=R_AUTH_BACKEND_SQL_DOWN` **oder** `Reason=R_AUTH_BACKEND_SQL_FAIL`

**Policy-Reasons (R_*)** — gelten für Policy-Outcomes:
- `Class=POLICY_DENY` / `Class=POLICY_RESTRICT` / `Class=OK`
  => `Reason=<R_POLICY_REASON>` (Single Source of Truth: **T03_POLICY_OUTCOME_REASON_CODES_DENY_RESTRICT_OK.txt**)

**Wichtig (SoT & Hygiene):**
- `R_AUTH_*` ist **reserviert** für Auth/Backend-Fehler (UNKNOWN / BADPASS / BACKEND_ERROR).
- Policy-Detailcodes werden **nicht** als `R_AUTH_*` geführt, sondern als `R_*` (z.B. `R_ACCOUNT_BANNED`, `R_QUOTA_EXCEEDED`, `R_OK`).

Fallback (nur wenn zwingend nötig, vermeiden):
- R_AUTH_UNSPECIFIED

### 3.3 Outcome / Prioritäten (deterministisch, SoT)

MUST:
- Outcome ist genau eine der folgenden Kategorien:
  - DENY      = Auth=REJECT (Tunnel wird NICHT aufgebaut)
  - RESTRICT  = Auth=ACCEPT (Tunnel wird aufgebaut, aber Walled Garden)
  - OK        = Auth=ACCEPT (Full Tunnel)

MUST Prioritätenkette (sticht immer nach unten):
0) BACKEND_ERROR (Deny/Reject, kein Ban)
1) Hard Administrative DENY (Reject, kein Ban)
2) Security/Operational DENY (Reject, kein Ban)
3) Self-Service RESTRICT (Accept+Walled Garden, kein Ban)
4) OK (Accept, Full Tunnel)

Kanonische Prioritäten (Final):
- 0 BACKEND_ERROR (D1a / Fail-Closed, NO BAN):
  - `Class=BACKEND_ERROR` + `Outcome=DENY`
  - `Reason=R_AUTH_BACKEND_SQL_DOWN` **oder** `Reason=R_AUTH_BACKEND_SQL_FAIL`

- 1 Hard Admin (DENY):
  - `Class=POLICY_DENY` + `Outcome=DENY`
  - `Reason=` (SoT: T03): `R_ACCOUNT_BANNED > R_ABUSE_HOLD > R_ACCOUNT_DISABLED > R_ACCOUNT_LOCKED_ADMIN`

- 2 Security / Operational Violations (DENY):
  - `Class=POLICY_DENY` + `Outcome=DENY`
  - Claim/Assign:
    - `R_CLAIM_IP_MISMATCH > R_CLIENT_NOT_ASSIGNED`
  - SimUse / RateLimit:
    - `R_SIMUSE_ACTIVE > R_RATE_LIMITED_*`

- 3 Self-Service States (RESTRICT / Walled Garden):
  - `Class=POLICY_RESTRICT` + `Outcome=RESTRICT`
  - `Reason=` (SoT: T03), deterministisch:
    - `R_ACCOUNT_NOT_VERIFIED / R_VERIFY_WALL_PENDING`
    - `R_CLAIM_REQUIRED`
    - `R_ACCOUNT_EXPIRED`
    - `R_QUOTA_EXCEEDED`

- 4 OK:
  - `Class=OK` + `Outcome=OK` + `Reason=R_OK`

## 4) SrcIP (Peer-WAN-IP)
MUST:
- SrcIP wird aus dem Attribut gezogen, das per Capture (tcpdump/radsniff) als Peer-WAN-IP bestätigt ist.
- Kandidat: Calling-Station-Id (Attr 31) – gilt nur, wenn Capture bestätigt: enthält WAN-Peer-IP.

MUST Safety:
- Wenn SrcIP nicht wie eine IPv4-Adresse aussieht, wird SrcIP=NA geloggt.
- Fail2ban matcht nur Events mit SrcIP=<HOST> (d.h. NA führt zu keinem Ban).

## 5) Logline Format (dediziert, maschinenlesbar)
MUST: Ein einziges, dediziertes Format (linelog), das Fail2ban trivial parsen kann.

MUST (key=value, 1 Zeile, stabil):
- Prefix: `F2B_EVENT:`
- Pflichtfelder: `Class`, `SrcIP`, `User`, `Outcome`, `Reason`

Canonical Logline:
`F2B_EVENT: Class=<CLASS> SrcIP=<SRCIP> User=<USER> Outcome=<OUTCOME> Reason=<R_CODE>`

Where:
- `Class` ∈ {UNKNOWN_USER, KNOWN_BADPASS, BACKEND_ERROR, POLICY_DENY, POLICY_RESTRICT, OK}
- `Outcome` ∈ {DENY, RESTRICT, OK}
- `Reason`:
  - `R_AUTH_*` nur für {UNKNOWN_USER, KNOWN_BADPASS, BACKEND_ERROR}
  - Policy-Reasons `R_*` (SoT: T03) für {POLICY_DENY, POLICY_RESTRICT, OK}

MUST: `SrcIP` ist eine WAN-IPv4/IPv6 **oder** der Fallback `NA` (invalid => Fail2ban matcht nicht).
MUST: Wenn `SrcIP=NA`, darf Fail2ban **niemals** bannen (kein <HOST> Match).

## 6) FreeRADIUS Flow (Klassifizierung) – deterministisch
MUST: Die Klassifikation muss deterministisch sein und darf nicht an Log-Texten hängen.
MUST: Es gibt exakt EINE F2B_EVENT Logline pro Request (ACCEPT oder REJECT).

### 6.1 Init (MUST)
Vor jeder Klassifikation werden die Control-Flags initialisiert (keine "uninitialized" Zustände):

update control {
    Tmp-String-0 := "UNKNOWN"     # IDENTITY_STATE: UNKNOWN | KNOWN | BACKEND_ERROR
    Tmp-String-1 := "NONE"        # AUTH_DETAIL: NONE | MSCHAP_FAIL
    Tmp-String-2 := "OK"          # POLICY_OUTCOME: OK | RESTRICT | DENY
    Tmp-String-3 := "NONE"        # POLICY_REASON: R_* | NONE
}

### 6.2 Authorize Phase (MUST) – SQL Return-Codes
sql
if (fail) {
    update control { Tmp-String-0 := "BACKEND_ERROR" }
}
elsif (notfound) {
    update control { Tmp-String-0 := "UNKNOWN" }
}
else {
    update control { Tmp-String-0 := "KNOWN" }
}

### 6.3 Authenticate Phase (MUST) – deterministischer MSCHAP Reject
Auth-Type MS-CHAP {
    mschap
    if (reject) {
        update control { Tmp-String-1 := "MSCHAP_FAIL" }
    }
}

### 6.4 Policy Engine (MUST) – Outcome + Reason Codes
Die Policy-Engine (siehe T03/D011) setzt:
- Tmp-String-2 = OK | RESTRICT | DENY
- Tmp-String-3 = R_* (Policy-Reason) oder NONE

Wichtig:
- RESTRICT bedeutet: Access-Accept + Walled-Garden/Filter-Id (B150/B155).
- DENY bedeutet: Access-Reject (kein Tunnel).
- Bei BACKEND_ERROR (SQL down) darf KEINE komplexe Policy ausgewertet werden (D1a).

### 6.5 Event Emission (Post-Auth-Type REJECT / Accept Hook)

**MUST:** Für jeden relevanten Outcome wird genau **eine** dedizierte `F2B_EVENT:` Logline geschrieben.

**Backend Error (D1a / Safety First)**
- Trigger: SQL `fail` (DB down / query failed / timeout)
- Emit:
  - `Class=BACKEND_ERROR`
  - `Outcome=DENY`
  - `Reason=R_AUTH_BACKEND_SQL_FAIL`
  - `SrcIP=<Calling-Station-Id|NA>`  (NA wenn ungültig)

*(Optional, wenn technisch eindeutig erkennbar):*
- Wenn du SQL "down" separat erkennst (z.B. connect refused), darfst du statt `R_AUTH_BACKEND_SQL_FAIL` auch `R_AUTH_BACKEND_SQL_DOWN` loggen.

**UNKNOWN_USER**
- Trigger: User im SQL `notfound`
- Emit:
  - `Class=UNKNOWN_USER`
  - `Outcome=DENY`
  - `Reason=R_AUTH_UNKNOWN_USER`

**KNOWN_BADPASS**
- Trigger: `Tmp-String-0=KNOWN` **und** `Tmp-String-1=MSCHAP_FAIL`
- Emit:
  - `Class=KNOWN_BADPASS`
  - `Outcome=DENY`
  - `Reason=R_AUTH_KNOWN_BADPASS`

**POLICY_RESTRICT (Walled Garden / Self-Service)**
- Trigger: Policy-Engine entscheidet `RESTRICT` (Access-Accept + Filter/Firewall)
- Emit:
  - `Class=POLICY_RESTRICT`
  - `Outcome=RESTRICT`
  - `Reason=<R_POLICY_REASON>` (SoT: T03, z.B. `R_ACCOUNT_NOT_VERIFIED`, `R_CLAIM_REQUIRED`, `R_ACCOUNT_EXPIRED`, `R_QUOTA_EXCEEDED`)

**POLICY_DENY (Hard Ban / Security)**
- Trigger: Policy-Engine entscheidet `DENY` (Access-Reject aus Policy, nicht Auth)
- Emit:
  - `Class=POLICY_DENY`
  - `Outcome=DENY`
  - `Reason=<R_POLICY_REASON>` (SoT: T03, z.B. `R_ACCOUNT_BANNED`, `R_CLAIM_IP_MISMATCH`, `R_SIMUSE_ACTIVE`, `R_RATE_LIMITED_*`)

**OK (Full Tunnel)**
- Trigger: Success
- Emit:
  - `Class=OK`
  - `Outcome=OK`
  - `Reason=R_OK`

### 6.6 SrcIP Extraktion (MUST)
SrcIP wird aus Calling-Station-Id (RADIUS Attr 31) genommen.
Falls Calling-Station-Id kein valides IP-Format hat:
- SrcIP := "NA" (und Fail2ban darf das niemals matchen, da Regex <HOST> verlangt).

## 7) Invariants / Constraints (MUST)
Klassifikations-Sicherheit:
- BACKEND_ERROR darf niemals in UNKNOWN_USER oder KNOWN_BADPASS umklassifiziert werden. (D1a)
- UNKNOWN_USER darf niemals in KNOWN_BADPASS umklassifiziert werden.
- KNOWN_BADPASS darf nur entstehen, wenn (&control:Tmp-String-0 == "KNOWN") UND (&control:Tmp-String-1 == "MSCHAP_FAIL").
- SrcIP=NA darf niemals von Fail2ban gebannt werden (Regex verlangt <HOST>).

Tmp-String Reservation (Invariant / Zukunftsschutz):
- &control:Tmp-String-0 ist exklusiv reserviert für IDENTITY_STATE (UNKNOWN|KNOWN|BACKEND_ERROR).
- &control:Tmp-String-1 ist exklusiv reserviert für AUTH_DETAIL (NONE|MSCHAP_FAIL).
- &control:Tmp-String-2 ist exklusiv reserviert für POLICY_OUTCOME (OK|RESTRICT|DENY).
- &control:Tmp-String-3 ist exklusiv reserviert für POLICY_REASON (R_*|NONE).
- Diese vier Tmp-Strings dürfen von keiner anderen Logik verwendet oder überschrieben werden.

Parsing-Regel:
- Text-Matching auf Module-Failure-Message ist NICHT kanonisch (nur Debug-Hilfe, nie Entscheidungsgrundlage).

## 8) Tests / Validierung (MUST)
T1 (Calling-Station-Id Nachweis):
- radsniff oder tcpdump auf localhost:1812 zeigt Attr 31 Calling-Station-Id im Access-Request.

T2 (SrcIP korrekt, kein localhost-ban):
- Ein Access-Reject erzeugt eine F2B_EVENT Logline mit SrcIP=<WAN-IP>.
- In der Logline darf niemals "from client localhost" als Source für Fail2ban dienen.

T3 (Regex Safety / Self-DoS Schutz):
- Fail2ban Regex matcht ausschließlich <HOST> aus "SrcIP=".
- SrcIP=NA darf niemals matchen.
- ignoreip muss zusätzlich 127.0.0.1/8 enthalten (Defense in Depth).

T4) BACKEND_ERROR (SQL down)
- Setup: DB down (sql fail)
- Expected:
  - `F2B_EVENT: Class=BACKEND_ERROR SrcIP=<NA|IP> User=<USER> Outcome=DENY Reason=R_AUTH_BACKEND_SQL_FAIL`

T5) Tmp-String Reservation (Collision Safety)
- Ensure: `&control:Tmp-String-0` und `&control:Tmp-String-1` bleiben exklusiv für F2B-Class/Auth-Detail reserviert.
- Test: bewusstes Überschreiben durch ein späteres Modul muss als FAIL gelten.

T6) Deterministic MSCHAP detection (no log-text parsing)
- Setup: Valid known user, wrong password => mschap reject => set `Tmp-String-1=MSCHAP_FAIL`
- Expected:
  - `F2B_EVENT: Class=KNOWN_BADPASS SrcIP=<HOST> User=<USER> Outcome=DENY Reason=R_AUTH_KNOWN_BADPASS`

T7) POLICY_RESTRICT (Self-Service) does NOT trigger Fail2ban
- Setup: `Outcome=RESTRICT` (z.B. NOT_VERIFIED / CLAIM_REQUIRED / EXPIRED / QUOTA)
- Expected:
  - `F2B_EVENT: Class=POLICY_RESTRICT SrcIP=<NA|IP> User=<USER> Outcome=RESTRICT Reason=<R_POLICY_REASON>`

T8) POLICY_DENY (Hard Ban / Security) does NOT trigger Fail2ban
- Setup: `Outcome=DENY` aus Policy (z.B. BANNED / CLAIM_IP_MISMATCH / SIMUSE_ACTIVE / RATE_LIMITED)
- Expected:
  - `F2B_EVENT: Class=POLICY_DENY SrcIP=<NA|IP> User=<USER> Outcome=DENY Reason=<R_POLICY_REASON>`

## 9) Verweise (Requires/Influences)
Requires:
- B050 (AAA / subaccounts per device)
- B056 (RADIUS schema mapping)
- D1a (SQL-first / fail-closed reject)
Influences:
- Fail2ban policy/jails (separate T-Datei)

## Changelog
Changelog:
## Changelog
Changelog:
- v0.3: Policy-Reasons vereinheitlicht (`Reason=<R_POLICY_REASON>` aus T03), `PReason` entfernt; Backend-Reason auf `R_AUTH_BACKEND_SQL_FAIL` (optional `...SQL_DOWN`) präzisiert; Beispiele/Tests/Emission angepasst.
- v0.2: R_AUTH_* Reason-Codes kanonisiert (Auth only), POLICY_RESTRICT ergänzt (Log-only, kein Ban), Init-Regel für Tmp-String-0 präzisiert, Tests um Reason-Checks erweitert.
- v0.1: Initialer Entwurf (F2B_EVENT, Klassen/Flags, NAT-sichere Klassifikation, Logline + Invariants + Tests)
================================================================================