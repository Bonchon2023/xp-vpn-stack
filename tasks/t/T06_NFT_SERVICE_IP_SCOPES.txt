# tasks/T/T06_NFT_SERVICE_IP_SCOPES.txt
Version: v0.1
Datum: 2026-01-06
Priority: MUST
Owner-Intent: Service-IP 10.77.0.1 muss erreichbar sein (intern), ohne WAN-Stealth zu brechen.

## 1) Zweck
nftables Scope-Spezifikation:
- WAN input: nur VPN-Ports (IKE/NAT-T/ESP etc.)
- VPN input: iif ppp* (User/Admin) -> service-ip Ports
- Restricted Mode Allowlist (DNS + Claim/Verify + optional status)
- Logging/counters für Tests

## 2) Scope / Nicht-Ziele
- Kein vollständiges nftables File als Patch (noch nicht).
- Keine tc QoS Regeln (T?? / B160).

## 3) Inputs (Truth Sources)
- blocks/B100_NFT_WAN_STEALTH.txt
- blocks/B110_NFT_L2TP_ONLY_VIA_IPSEC.txt
- blocks/B120_NFT_FORWARD_NAT_FULLTUNNEL.txt
- blocks/B150_Walled Garden_Restricted_Mode_(...) .txt
- blocks/B210_DNS_ENFORCEMENT_DNAT53.txt
- D005_PANEL_SCOPE_USER_ACCESS

## 4) Outputs (Deliverables)
- `docs/nft_service_ip_scopes.md`
  - service ports list (DNS/HTTP/HTTPS/NTP/diag/panel/etc.)
  - role matrix: User vs Admin vs Restricted
  - allow/deny rules narrative (chain-level)
- `tests/nft_scope_scan.md`
  - WAN scan expectations
  - VPN access checks per role

## 5) Dependencies
- T03 (apply/reconcile mechanism beeinflusst rule updates)
- D005 (welche Web-Endpunkte dürfen User erreichen?)

## 6) Risiken / Randfälle
- Zu restriktiv: DNS/Portal nicht erreichbar -> total outage.
- Zu offen: WAN-Stealth broken, Admin endpoints exposed.
- Restricted logic mismatch mit Gate State Matrix.

## 7) Tests / Acceptance Criteria (messbar)
MUST:
- WAN scan zeigt nur erlaubte VPN-Ports.
- User-Netz:
  - erreicht DNS (53) + erlaubt definierte endpoints (claim/verify/status je Decision)
  - erreicht NICHT admin-only endpoints (pma/db/admin UI)
- Restricted:
  - erreicht nur Allowlist, Rest drop.
SHOULD:
- Logging/Counters verifizieren: DNAT53 trifft, policy counters steigen.

## 8) Offene Punkte / Entscheidungen
- D005: user panel endpoints ja/nein?
- Welche Ports genau auf 10.77.0.1 für user erlaubt (z.B. 80/443 nur für portal/status)?

## 9) Changelog
- v0.1 (2026-01-06): Task-Datei angelegt.