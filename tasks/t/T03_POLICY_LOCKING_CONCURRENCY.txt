# tasks/T/T03_POLICY_LOCKING_CONCURRENCY.txt
Version: v0.1
Datum: 2026-01-06
Priority: MUST
Owner-Intent: Apply/Reconcile darf nicht überlappen → deterministischer Endzustand.

## 1) Zweck
Verbindliches Locking/Concurrency-Modell für:
- `vpn-policy-apply`
- `vpn-policy-reconcile`
Trigger-Quellen: ip-up hooks, Panel-Events, reconcile timer.

## 2) Scope / Nicht-Ziele
- Keine konkreten nftables/tc Regeln (T06).
- Keine Implementierung als Patch in systemd/scripts; nur Spezifikation + Tests.

## 3) Inputs (Truth Sources)
- blocks/B166_POLICY_APPLY_RECONCILE.txt (Exit codes, optional lock, reconcile loop)
- blocks/B167_WIRING_HOOKS_SYSTEMD.txt (systemd wiring, lock optional)
- 03_ASSUMPTIONS_AND_RULES.txt (z.B. „SQL ist Truth“, apply ist idempotent)

## 4) Outputs (Deliverables)
- `docs/policy_locking_model.md`
  - Single-writer Regel
  - Lock-Mechanismus (z.B. flock) verbindlich oder optional (Entscheidung in diesem Task)
  - Retry/Backoff Semantik für TEMPFAIL_LOCKED
  - Idempotenz-Regeln (state recomputed from DB truth)
- `tests/concurrency_regression.md`
  - parallel trigger matrix
  - expected final state

## 5) Dependencies
- T01 (DB truth muss existieren)
- Optional: T02 (wenn apply/reconcile RADIUS user mapping berührt)

## 6) Risiken / Randfälle
- Partial state (nft gesetzt, tc fehlt) → user experience bricht deterministisch.
- Flapping: häufige status toggles, overlapping applies.
- Lock starvation: reconcile loop blockiert apply dauerhaft, wenn nicht geregelt.

## 7) Tests / Acceptance Criteria (messbar)
MUST:
- Parallel trigger test:
  - ip-up + panel change + reconcile 동시에 -> final state korrekt, keine Partial States.
- Apply idempotent:
  - apply 2x hintereinander -> identischer state (nft/tc/rad state).
- TEMPFAIL_LOCKED Semantik:
  - definierter Exit + definierter retry/backoff/queue Pfad (dokumentiert und testbar).

## 8) Offene Punkte / Entscheidungen
- Locking MUSS oder optional? (Issue sagt: optional ist riskant → Empfehlung: MUSS, aber du entscheidest)
- Backoff Strategie: fixed vs exponential.

## 9) Changelog
- v0.1 (2026-01-06): Task-Datei angelegt.