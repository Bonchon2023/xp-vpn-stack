================================================================================
T03_POLICY_OUTCOME_REASON_CODES_DENY_RESTRICT_OK.txt
Version: v0.1.0 (ENTWURF)
Status: ENTWURF (Phase 3)
================================================================================

## 1) Zweck / Ziel
Spezifiziert den kanonischen Reason-Code Katalog (R_...) und die deterministische
Prioritätenlogik für VPN-Auth-Entscheidungen mit sauberer Trennung:
- DENY  (Reject: kein Tunnel)
- RESTRICT (Accept + Walled Garden Scope)
- OK (Full Tunnel)

Zusätzlich: Observability-Logging in eine stabile F2B_EVENT Logzeile, ohne dass
Fail2ban bei SQL-Ausfall oder Policy-Zuständen NAT-collateral Bans erzeugt.

## 2) Scope
Gilt für den Auth-Entscheidungspunkt im VPN-Login-Flow (FreeRADIUS L2TP/IPsec).
Nicht Scope: konkrete nftables/tc Implementierung (die ist in den B-Blöcken).

## 3) Kanonische Outcomes (MUST)
Outcome muss exakt einer dieser Werte sein:
- DENY      := RADIUS Access-Reject (Tunnel wird NICHT aufgebaut)
- RESTRICT  := RADIUS Access-Accept, aber Policy wird "Walled Garden" erzwingen
- OK        := RADIUS Access-Accept + Full Tunnel

## 4) Kanonische Reason-Codes (R_...) (MUST)
Format:
- Prefix "R_"
- UPPERCASE + "_" nur
- Jeder Request endet in genau 1 Reason-Code (Single Reason).

### 4.1 Outcome: DENY (Reject) — Hard / Security / Backend (MUST-Liste)
R_AUTH_BACKEND_SQL_DOWN
- Bedeutung: SQL/Backend nicht erreichbar (Connection down).
- Outcome: DENY
- Fail2ban: NEIN (muss ignoriert werden)
- Hinweis: D1a Safety Rule. (Auth-Reason; SoT in T01)

R_AUTH_BACKEND_SQL_FAIL
- Bedeutung: SQL erreichbar, aber Query/Backend-Operation schlägt fehl.
- Outcome: DENY
- Fail2ban: NEIN (muss ignoriert werden)
- Hinweis: D1a Safety Rule. (Auth-Reason; SoT in T01)

R_ACCOUNT_BANNED
- Bedeutung: Hard Ban (abuse/banned). Kein Tunnel, kein Self-Service.
- Outcome: DENY
- Fail2ban: NEIN (NAT-sicher: Ban nicht über IP)
- Kommentar: Ban ist Policy, kein Angriffssignal.

R_ABUSE_HOLD
- Bedeutung: Temporärer Abuse-Hold durch Admin/Automation.
- Outcome: DENY
- Fail2ban: NEIN

R_ACCOUNT_DISABLED
- Bedeutung: Account deaktiviert (administrativ).
- Outcome: DENY
- Fail2ban: NEIN

R_ACCOUNT_LOCKED_ADMIN
- Bedeutung: Admin Lock (z.B. Compliance/Support).
- Outcome: DENY
- Fail2ban: NEIN

R_CLAIM_IP_MISMATCH
- Bedeutung: Claim Sicherheitsverletzung (Token/Bind mismatch).
- Outcome: DENY
- Fail2ban: NEIN (Policy/Security; NAT-Safety => kein IP-Ban via Fail2ban)
- Hinweis: Falls du je "Ban bei Mismatch" willst -> eigener Mechanismus (separat), nicht Fail2ban.

R_CLIENT_NOT_ASSIGNED
- Bedeutung: Subaccount existiert, aber keine vpn_connection / kein gültiges Assignment.
- Outcome: DENY
- Fail2ban: NEIN (Policy/Provisioning, nicht Angriffsbeweis)

R_SIMUSE_ACTIVE
- Bedeutung: Simultaneous-Use Schutz (Session lebt und Takeover nicht erlaubt).
- Outcome: DENY
- Fail2ban: NEIN (sonst NAT-Collateral)

R_RATE_LIMITED
- Bedeutung: RADIUS Policy Rate-Limit greift (z.B. zu viele Logins pro User/IP auf App-Ebene).
- Outcome: DENY
- Fail2ban: NEIN (Fail2ban schützt bereits via Jails; dies ist eine interne Policy)
- Note: IKE-Floods werden bereits von strongSwan geblockt (Jail J1) und erreichen RADIUS nicht.

[Optional Erweiterungen, nur wenn im Master so spezifiziert:]
R_REGION_BLOCKED
R_ADMIN_ONLY_SCOPE
R_MAINTENANCE_LOCK

### 4.2 Outcome: RESTRICT (Accept + Walled Garden) — Self-Service (MUST-Liste)
R_ACCOUNT_NOT_VERIFIED
- Bedeutung: Email/Verify noch nicht abgeschlossen.
- Outcome: RESTRICT
- Ziel: User MUSS 10.77.0.1 erreichen können (Verify Self-Service).

R_VERIFY_WALL_PENDING
- Bedeutung: Verify ist gestartet / pending (Code bereits gesendet o.ä.).
- Outcome: RESTRICT

R_CLAIM_REQUIRED
- Bedeutung: Account ist verified/allowed, aber Device/Client noch nicht geclaimt.
- Outcome: RESTRICT
- Ziel: Token eingeben / Claim im Panel.

R_ACCOUNT_EXPIRED
- Bedeutung: Vertrag/Lifecycle abgelaufen.
- Outcome: RESTRICT (Default, kein Hard Expiry)
- Ziel: Renew / Verlängerung Self-Service (wenn vorgesehen).

R_QUOTA_EXCEEDED
- Bedeutung: Quota leer.
- Outcome: RESTRICT
- Ziel: Quota-Status sehen / aufladen / Ablauf sichtbar.

### 4.3 Outcome: OK
R_OK
- Bedeutung: alles grün, Full Tunnel erlaubt.
- Outcome: OK

## 5) Kanonische Prioritätenlogik (MUST)
Deterministische Reihenfolge, first-match wins.

PRIO 0: Backend Failure (sticht alles)
- Wenn SQL Connection down -> R_AUTH_BACKEND_SQL_DOWN -> Outcome DENY
- Wenn SQL Query/Operation fail -> R_AUTH_BACKEND_SQL_FAIL -> Outcome DENY

PRIO 1: Hard Administrative Bans (DENY)
- R_ACCOUNT_BANNED > R_ABUSE_HOLD > R_ACCOUNT_DISABLED > R_ACCOUNT_LOCKED_ADMIN

PRIO 2: Security & Operational Violations (DENY)
- R_CLAIM_IP_MISMATCH > R_CLIENT_NOT_ASSIGNED > R_SIMUSE_ACTIVE > R_RATE_LIMITED

PRIO 3: Self-Service States (RESTRICT)
- 3.1 Verify: R_VERIFY_WALL_PENDING / R_ACCOUNT_NOT_VERIFIED
- 3.2 Claim: R_CLAIM_REQUIRED
- 3.3 Expired: R_ACCOUNT_EXPIRED
- 3.4 Quota: R_QUOTA_EXCEEDED

PRIO 4: Success
- R_OK

Tie-break Regel (Verify):
- Wenn Verify-Prozess begonnen (pending) -> R_VERIFY_WALL_PENDING
- Sonst -> R_ACCOUNT_NOT_VERIFIED

## 6) Observability-Logging (F2B_EVENT) (MUST)
Jeder Reject/Accept MUSS genau eine maschinenlesbare Logzeile erzeugen:

F2B_EVENT: Class=<CLASS> Outcome=<OUTCOME> Reason=<R_...> SrcIP=<SRCIP> User=<USER_OR_NA>

Class Werte (MUST, kanonisch):
- UNKNOWN_USER
- KNOWN_BADPASS
- BACKEND_ERROR
- POLICY_DENY
- POLICY_RESTRICT
- OK

Mapping (MUST, kanonisch; keine Alternativen):
- UNKNOWN_USER    -> Outcome DENY     -> Reason=R_AUTH_UNKNOWN_USER        (Auth-Reason; SoT in T01)
- KNOWN_BADPASS   -> Outcome DENY     -> Reason=R_AUTH_KNOWN_BADPASS       (Auth-Reason; SoT in T01)
- BACKEND_ERROR   -> Outcome DENY     -> Reason=R_AUTH_BACKEND_SQL_DOWN    (oder R_AUTH_BACKEND_SQL_FAIL; SoT in T01)
- POLICY_DENY     -> Outcome DENY     -> Reason=R_.                        (aus 4.1)
- POLICY_RESTRICT -> Outcome RESTRICT -> Reason=R_.                        (aus 4.2)
- OK              -> Outcome OK       -> Reason=R_OK

Regel:
- Auth-Reasons (R_AUTH_*) werden NICHT in T03 definiert, sondern in T01 (Single Source of Truth).

Fail2ban Match-Regel (MUST):
- Fail2ban jails dürfen NUR UNKNOWN_USER und KNOWN_BADPASS matchen.
- BACKEND_ERROR / POLICY_* / OK werden nie gebannt.

SrcIP Regel (MUST):
- SrcIP wird aus Calling-Station-Id extrahiert, nur wenn valide IP.
- Wenn nicht valide -> SrcIP=NA (Fail2ban darf das nicht matchen).

## 7) Constraints / Invariants (MUST)
- Es gibt pro Request genau 1 Outcome und genau 1 Reason.
- Reason-Codes immer R_... Format.
- R_AUTH_* Reason-Codes sind exklusiv in T01 definiert (SoT) und werden in T03 nicht dupliziert.
- UNKNOWN_USER und KNOWN_BADPASS müssen immer Reason=R_AUTH_UNKNOWN_USER bzw. Reason=R_AUTH_KNOWN_BADPASS loggen (keine alternativen Reason-Namen).
- Backend fail -> Reason ist R_AUTH_BACKEND_SQL_DOWN oder R_AUTH_BACKEND_SQL_FAIL (SoT T01); niemals UNKNOWN/BADPASS.
- Banned/Disabled/Locked -> niemals RESTRICT.
- Self-Service-Reasons (R_ACCOUNT_NOT_VERIFIED, R_VERIFY_WALL_PENDING, R_CLAIM_REQUIRED, R_ACCOUNT_EXPIRED, R_QUOTA_EXCEEDED) -> niemals DENY (außer Backend fail).

## 8) Tests / Validierung (MUST)
T1 Backend down:
- SQL connection down -> Log: Class=BACKEND_ERROR Outcome=DENY Reason=R_AUTH_BACKEND_SQL_DOWN
- SQL query/operation fail -> Log: Class=BACKEND_ERROR Outcome=DENY Reason=R_AUTH_BACKEND_SQL_FAIL
- Fail2ban: darf NICHT matchen

T2 Banned user:
- SQL ok + status banned -> Class=POLICY_DENY Outcome=DENY Reason=R_ACCOUNT_BANNED
- Fail2ban: darf NICHT matchen

T3 Not verified:
- SQL ok + not verified -> Class=POLICY_RESTRICT Outcome=RESTRICT Reason=R_ACCOUNT_NOT_VERIFIED

T4 Verify pending:
- SQL ok + pending flag -> Outcome=RESTRICT Reason=R_VERIFY_WALL_PENDING

T5 Claim required:
- SQL ok + verified + not claimed -> Outcome=RESTRICT Reason=R_CLAIM_REQUIRED

T6 Quota exceeded:
- SQL ok + quota empty -> Outcome=RESTRICT Reason=R_QUOTA_EXCEEDED

T7 SimUse:
- SQL ok + simuse hit -> Outcome=DENY Reason=R_SIMUSE_ACTIVE

T8 Unknown user:
- SQL notfound -> Class=UNKNOWN_USER Outcome=DENY Reason=R_AUTH_UNKNOWN_USER
- Fail2ban: matcht (Unknown jail)

T9 Known badpass:
- SQL ok known + MSCHAP reject -> Class=KNOWN_BADPASS Outcome=DENY Reason=R_AUTH_KNOWN_BADPASS
- Fail2ban: matcht (Known jail heavy threshold)

T10 SrcIP invalid:
- Calling-Station-Id garbage -> SrcIP=NA -> Fail2ban must not match

## 9) Verweise (Requires/Influences)
Requires:
- B150 (Walled Garden)
- B155 (Verify/Claim Wall)
- D1a (SQL First Fail-Closed)
- D011 (Outcome/Reason Entscheidung: DENY/RESTRICT/OK + Prioritätenkette)
- D010 (Fail2ban classification decision: Class-Konzept inkl. POLICY_DENY/RESTRICT)
- T01 (R_AUTH_* Katalog + Event-Classification SoT)

Influences:
- B166/B167 (Policy apply + wiring)
- T02 (Fail2ban Jails + Policy Values)

================================================================================
Changelog:
- v0.1.0 (ENTWURF): Initial Spec for R_ Reason Codes, DENY/RESTRICT split, priority chain, and F2B_EVENT mapping.
================================================================================