0001| ==================================================================================================
0002| MASTER-KONZEPT v1.8 (ZEILENFEST)
0003| XP/Vista Full-Tunnel VPN auf Debian 13 (from scratch) — L2TP/IPsec (strongSwan + xl2tpd + pppd)
0004| Policies in Linux: nftables + tc + SQL/RADIUS + interner Webstack + DNS-Stack + MITM-Blockpage
0005| ==================================================================================================
0006|
0007| 1) ZIELSETZUNG (MUST)
0008| 1.1| Dedizierter VPN-Server für Windows XP (optional Vista).
0009| 1.2| Full-Tunnel erzwungen: gesamter Client-Traffic läuft durch den VPN-Server ins Internet.
0010| 1.3| “Idiotensicher”: Clientseitig minimal (FQDN + User/Pass + PSK), alles andere automatisch.
0011| 1.4| Keine WAN-Services außer VPN: von außen idealerweise nur UDP 500/4500 + ESP sichtbar.
0012| 1.5| Peer-Isolation: verkaufte Geräte sehen sich untereinander nicht (User↔User strikt DROP).
0013| 1.6| Zwei logisch getrennte VPN-Bereiche: User (verkaufte Geräte) vs Admin (deine Geräte).
0014| 1.7| Bandbreitenkontrolle pro Verbindung (pppX) + manuelle Drosselung + Quota/Expiry möglich.
0015| 1.8| DNS-Stack (Unbound + AdGuardHome) + später DNS-Zwang (DNAT 53) für “DNS kann nicht umgangen werden”.
0016| 1.9| Interner Webstack (OpenResty + PHP-FPM + MariaDB + phpMyAdmin) für:
0017|     | - User-Panel (Login nur über VPN; IP-Abgleich/Whitelist im Panel)
0018|     | - Statusseite (vpn.status)
0019|     | - Admin-Panel / Admin-Tools
0020|     | - HTTPS-Blockpage (MITM) für AdGuard-Blocklisten (“Custom IP” -> interne Blockpage)
0021| 1.10| ONBOARDING / BUSINESS-ENFORCEMENT (MUST):
0022|     | - Gate #1 (CLAIM): Nach Ablauf der Trial-Frist wird Internet gesperrt (Walled Garden), bis der Käufer einen Panel-Account erstellt UND die Verbindung claimed (Verknüpfung Panel-User ↔ VPN-Connection).
0023|     | - Gate #2 (EMAIL VERIFY): Nach dem Claim läuft Internet sofort wieder (unabhängig von Verifikation), ABER wenn die Email nicht bis zur Verify-Deadline bestätigt ist, wird wieder Walled Garden erzwungen, bis verifiziert.
0024|     | - Ziel: minimale Supportfälle + am Ende verifizierbare Kontakt-Email für Abuse/Compliance.
0025|
0026| 2) GRUNDPRINZIP (MUST): “VPN-Software nur Tunnel – Kontrolle im OS”
0027| 2.1| strongSwan: nur IPsec Terminierung (IKEv1 für XP-Kompatibilität).
0028| 2.2| xl2tpd/pppd: L2TP/PPP Einwahl, IP-Vergabe via PPP/IPCP (keine DHCP-Abhängigkeit).
0029| 2.3| nftables: zentrale Policy (WAN-Exposure, Forwarding, NAT, Isolation, Missbrauchsschutz).
0030| 2.4| tc: Traffic Shaping pro pppX (User/Admin Limits, Live-Drosselung).
0031| 2.5| SQL/RADIUS ist “Source of Truth” ab Tag 1 (keine chap-secrets Migration).
0032| 2.6| Webstack und Services sind strikt an interne Service-IP gebunden (10.77.0.1/32 auf lo).
0033|
0034| 3) PROTOKOLLENTSCHEIDUNG (MUST): L2TP/IPsec statt SoftEther
0035| 3.1| SoftEther-Client ist zu fehleranfällig/zu viele Optionen für Käufer -> raus.
0036| 3.2| L2TP/IPsec ist in XP/Vista “built-in” -> keine Fremdsoftware nötig.
0037| 3.3| IP-Zuweisung via PPP/IPCP -> Client muss keine IP/Gateway/DNS manuell setzen.
0038|
0039| 4) NETZWERKDESIGN (MUST)
0040| 4.1| Service-IP (stabiler Anker für alle internen Services):
0041|     | - 10.77.0.1/32 auf loopback (lo)
0042|     | - existiert immer (auch ohne aktive PPP-Sessions)
0043| 4.2| Zwei VPN-Netze:
0044|     | - User-Netz:  10.77.10.0/24  (verkaufte Geräte)
0045|     | - Admin-Netz: 10.77.20.0/24  (deine Geräte)
0046| 4.3| IP-Vergabe:
0047|     | - via PPP/IPCP (pppd)
0048|     | - feste IPs pro “Verbindung” (nicht nur pro Kunde)
0049| 4.4| “1 Kunde -> n Verbindungen” (MUST):
0050|     | - Pro Gerät/Verbindung eigene Sub-Accounts (z.B. max-laptop, max-pc)
0051|     | - Jede Sub-Connection bekommt eine feste IP (für Regeln, Stats, Quota, tc)
0052|     | - Damit bleiben Policy, Speedlimit, Accounting und Abuse-Tracking sauber pro Gerät.
0053|
0054| 5) DNS-/FQDN-KONZEPT (MUST)
0055| 5.1| Client verbindet per öffentlicher FQDN (z.B. vpn.deinedomain.tld).
0056| 5.2| FQDN muss vor Tunnelaufbau über normales Internet-DNS auflösbar sein.
0057| 5.3| rDNS/PTR beim Provider: optional (nice-to-have), kein Muss für Funktion.
0058| 5.4| IPv6: bewusst deaktiviert (Leak-Vermeidung):
0059|     | - Provider-seitig IPv6 aus
0060|     | - OS-seitig Kernel IPv6 deaktivieren
0061|
0062| 6) KOMPATIBILITÄT: NAT-T / LEGACY-KRYPTO / MTU (MUST)
0063| 6.1| NAT-Traversal (Showstopper, MUST):
0064|     | - XP/Vista (und teils neuere Windows) benötigen Registry-Key für NAT-T:
0065|     |   AssumeUDPEncapsulationContextOnSendRule = 2
0066|     | - Ohne diesen Fix: häufig Fehler 789/809 oder IPsec steht, aber L2TP/1701 fließt nicht.
0067|     | - Konsequenz: Setup-Tool MUSS das setzen + Reboot/Neustart verlangen.
0068| 6.2| Legacy-Krypto (IKEv1) für XP (MUST):
0069|     | - XP kann i.d.R. nur alte Proposals zuverlässig (z.B. 3des/sha1/modp1024).
0070|     | - strongSwan muss so konfiguriert werden, dass XP-Proposals akzeptiert werden.
0071| 6.3| Debian 13 Crypto-Konflikt (MUST, kritisch):
0072|     | - Debian 13 / OpenSSL 3.x kann Legacy-Algorithmen blockieren (SHA1/3DES).
0073|     | - Lösungspfad A (bevorzugt, minimal invasiv): OpenSSL Legacy Provider aktivieren
0074|     |   (systemweit in openssl.cnf), sodass strongSwan die Legacy-Ciphers nutzen kann.
0075|     | - Lösungspfad B (Fallback): strongSwan gegen permissivere Crypto-Backend-Variante bauen
0076|     |   (z.B. libgcrypt Backend) ODER eigene OpenSSL-Version (nur wenn A nicht reicht).
0077|     | - MUST: Vor produktivem Rollout XP Handshake in Testphase verifizieren.
0078| 6.4| MTU/MSS (Full-Tunnel Killer, MUST):
0079|     | - Massive Kapselung: TCP -> PPP -> L2TP -> ESP -> UDP -> IP
0080|     | - Symptom ohne Fix: Ping ok, aber HTTPS lädt langsam/gar nicht, Timeouts.
0081|     | - Lösung: TCP MSS Clamping in nftables für SYN Pakete (Forward Pfad).
0082|     | - Startwert: MSS 1280 oder 1300 (sicherer eher 1280).
0083|
0084| 7) FIREWALL & ROUTING (nftables) – ZENTRALE POLICY (MUST)
0085| 7.1| WAN-Interface: ens13 (dein reales Interface; NICHT ens18/tap/etc.)
0086| 7.2| WAN Exposure (“Stealth”, MUST):
0087|     | - erlauben auf ens13:
0088|     |   UDP 500  (IKE)
0089|     |   UDP 4500 (NAT-T)
0090|     |   ESP (IP proto 50)
0091|     | - optional: ICMP echo-request droppen oder rate-limit (Stealth)
0092|     | - SSH von WAN: blocken + zusätzlich sshd nicht an WAN binden
0093| 7.3| L2TP-Schutz (MUST):
0094|     | - UDP 1701 darf NICHT “blank” aus dem Internet erreichbar sein.
0095|     | - nftables Regel: UDP 1701 nur akzeptieren, wenn Paket IPsec/XFRM-entschlüsselt ist.
0096|     | - Implementierung: meta ipsec exists (oder xfrm match) für 1701 accept, sonst drop.
0097| 7.4| Forwarding (Full-Tunnel, MUST):
0098|     | - forward erlauben: 10.77.10.0/24 -> ens13 (Internet)
0099|     | - forward erlauben: 10.77.20.0/24 -> ens13 (Internet)
0100|     | - return traffic: conntrack established/related accept
0101| 7.5| NAT Masquerade (MUST):
0102|     | - postrouting masquerade für beide VPN-Netze Richtung ens13
0103| 7.6| Peer-Isolation (MUST):
0104|     | - User-Netz: 10.77.10.0/24 -> 10.77.10.0/24 = DROP (kein User↔User)
0105|     | - Admin↔User: Policy separat definierbar (Default: Admin darf User NICHT direkt scannen)
0106| 7.7| Missbrauchsschutz / Reputation (MUST):
0107|     | - Outbound blocken (Forward chain) für User-Netz mindestens:
0108|     |   TCP 25, 465, 587 (SMTP)
0109|     |   TCP 445 (SMB)
0110|     |   TCP/UDP 137-139 (NetBIOS)
0111|     | - Ziel: Botnet/Spam über deine Exit-IP minimieren -> Schutz vor Blacklists/Abuse.
0112|
0113| 8) VPN-DIENSTE (MUST)
0114| 8.1| strongSwan (IKEv1, NAT-T):
0115|     | - DPD aktiv (Ghost Sessions verhindern):
0116|     |   dpd_delay=30s, dpd_timeout=120s, dpd_action=clear
0117|     | - NAT-T aktiv (UDP 4500)
0118|     | - XP-kompatible Proposals (z.B. ike=3des-sha1-modp1024; esp=3des-sha1)
0119|     | - Legacy Provider / Crypto-Backend gemäß 6.3.
0120| 8.2| xl2tpd + pppd:
0121|     | - pppd LCP Echo (Ghost Sessions verhindern):
0122|     |   lcp-echo-interval 30, lcp-echo-failure 3
0123|     | - IP-Vergabe via IPCP (Pools/Fixed-IP per User/Subaccount)
0124|     | - ip-up/ip-down Hooks sind zentrale Integrationspunkte (tc, logging, quota).
0125|
0126| 9) AUTH / AAA: FREE RADIUS + SQL (MUST, ab Tag 1)
0127| 9.1| Ziel: Keine chap-secrets als Truth, keine spätere Migration.
0128| 9.2| FreeRADIUS:
0129|     | - Authentication: User/Subaccount + Passwort
0130|     | - Authorization: feste IP je Subaccount (Framed-IP-Address)
0131|     | - Accounting: Session Start/Stop, Assigned IP, Duration, optional Bytes (radacct)
0132| 9.3| SQL DB (MariaDB/MySQL lokal auf derselben Box):
0133|     | - Tabellen für:
0134|     |   Customers (Kundenkonto)
0135|     |   VPN_Connections (Subaccounts pro Gerät; feste IP; Limits; Status; expiry; quota)
0136|     |   Accounting (radacct)
0137|     |   PanelUsers/ResetTokens/Emails etc. (für Webpanel)
0138| 9.4| Onboarding-Felder (MUST, für Gate #1/#2)
0139|     | - VPN_Connections zusätzlich:
0140|     |   status: PREPROVISIONED | CLAIMED | DISABLED
0141|     |   customer_id (NULL bis Claim)
0142|     |   trial_until (Gate #1 Start)
0143|     |   verify_deadline (Gate #2 Start)
0144|     |   claim_deadline (Hard stop optional, aber empfohlen)
0145|     |   claim_token_hash (Token liegt auf Gerät; im Panel eingegeben; DB speichert nur Hash)
0146|     | - Customers zusätzlich:
0147|     |   email_verified_at (NULL bis Verify)
0148| 9.5| ip-up Script Datenquelle (MUST):
0149|     | - ip-up liest Parameter lokal (DB lokal auf derselben Box) oder aus lokalem Cache.
0150|     | - Keine Netz-Dependencies, die den Connect blockieren (DB muss lokal/robust sein).
0151|
0152| 10) BANDWIDTH / SPEEDLIMIT / DROSSELUNG (tc) (MUST)
0153| 10.1| Grundsatz: nftables ist nicht Shaper; tc macht Shaping.
0154| 10.2| PPP Vorteil: jede Verbindung hat pppX -> pro Client direkt limitierbar.
0155| 10.3| Standard Shaper (MUST):
0156|     | - CAKE (oder fq_codel) als root qdisc auf pppX
0157|     | - Beispiel: tc qdisc replace dev pppX root cake bandwidth 10mbit
0158| 10.4| Automatisierung (MUST):
0159|     | - ip-up Hook setzt tc je pppX anhand DB-Parameter (user/admin/individual).
0160| 10.5| Manuelle Drosselung (MUST):
0161|     | - live tc qdisc replace möglich (sofort wirksam).
0162| 10.6| Optional (Phase später): Ingress shaping via IFB (Upload exakt begrenzen).
0163|
0164| 11) DNS-STACK (PHASEN) (MUST in späteren Phasen)
0165| 11.1| Phase DNS-Stack:
0166|     | - Unbound nur lokal (127.0.0.1:5335)
0167|     | - AdGuardHome:
0168|     |   DNS:  10.77.0.1:53
0169|     |   UI:   10.77.0.1:2000 (Admin only)
0170|     | - User-Netz darf DNS (53), darf NICHT UI (2000)
0171| 11.2| DNS-Zwang (Phase später):
0172|     | - nftables DNAT TCP/UDP 53 von ppp* -> 10.77.0.1:53
0173|     | - egal was Client einträgt -> DNS immer “deins”
0174| 11.3| AdGuard Blockpage Routing (MUST für Premium UX):
0175|     | - AdGuard “Blocking mode: Custom IP” -> 10.77.0.1 (Webstack)
0176|     | - DNS Rewrite: vpn.status -> 10.77.0.1 (Panel/Status)
0177|
0178| 12) WEBSTACK INTERN (MUST)
0179| 12.1| Bind-Policy:
0180|     | - Webstack lauscht nur auf 10.77.0.1 (niemals WAN).
0181| 12.2| Stack-Entscheidung (MUST):
0182|     | - OpenResty als Frontend (Nginx+Lua) + PHP-FPM (PHP8) + MariaDB + phpMyAdmin
0183|     | - Kein Apache als zweiter Server.
0184| 12.3| Zugriffspolitik:
0185|     | - Admin Services: strikte Freigabe nur aus Admin-Netz (z.B. /admin, /pma, UI:2000)
0186|     | - User Panel: Zugriff aus User-Netz erlaubt, aber Login nur über VPN und IP-Abgleich.
0187| 12.4| User Login IP-Abgleich (MUST):
0188|     | - Panel prüft: Client-IP muss zu einer erlaubten VPN-IP des Kunden passen.
0189|     | - Kunde kann im Panel festlegen, von welchen seiner VPN-IPs Login erlaubt ist
0190|       (Whitelist pro Connection/Subaccount) – Default: alle eigenen VPN-IPs erlaubt.
0191| 12.5| Passwort-Reset / Email (MUST):
0192|     | - Panel nutzt externen Mailserver (dein Server, hohe Reputation) für “Passwort vergessen”.
0193|
0194| 13) HTTPS-BLOCKPAGE (MITM) + “UNIVERSELLES” TRUST (MUST)
0195| 13.1| Ziel:
0196|     | - HTTP und HTTPS geblockte Requests sollen auf Blockseite landen (nicht nur HTTP).
0197| 13.2| Mechanik:
0198|     | - Interne Root-CA (ggf. Intermediate)
0199|     | - On-the-fly Leaf Zertifikate pro Host (SNI) via OpenResty Lua
0200|     | - Zertifikate gecached (Disk/Memory) um CPU zu sparen
0201| 13.3| DoS-Schutz (MUST):
0202|     | - RateLimit pro Client-IP für neue Zert-Generierung
0203|     | - Max Requests/sec + Burst; bei Überschreitung: fallback auf statische Blockantwort
0204| 13.4| Grenzen (MUST, ehrlich):
0205|     | - HSTS/Pinning/CT kann bei manchen Domains/Apps trotzdem blocken.
0206|     | - Für “typische” Web-Surfaces soll es funktionieren; Pinning-Apps sind Edgecase.
0207|
0208| 14) MYPAL TRUSTSTORE (MUST)
0209| 14.1| Realität:
0210|     | - MyPal nutzt NSS Zertdatenbank (cert8.db/cert9.db), NICHT Windows Zertstore.
0211| 14.2| Setup-Paket MUSS:
0212|     | - MyPal Profile finden
0213|     | - NSS certutil (Mozilla NSS Tools) inkl. benötigter DLLs mitliefern (portable bundle)
0214|     | - CA in NSS DB importieren (silent)
0215|
0216| 15) ZEIT / NTP STRATEGIE (MUST)
0217| 15.1| Problem:
0218|     | - XP hat oft falsche Zeit (CMOS), TLS Zertifikate “not yet valid”.
0219| 15.2| Setup-Tool (MUST):
0220|     | - Pre-Connect: best-effort Zeitsync über normales Internet (Fallback-Logik)
0221|     | - Post-Connect: NTP Source auf 10.77.0.1 setzen (dauerhaft)
0222| 15.3| Server:
0223|     | - lokaler NTP Dienst auf 10.77.0.1 (UDP 123) verfügbar
0224|     | - optional: NTP Redirect (udp/123) von Clients -> 10.77.0.1 (damit “immer korrekt”)
0225|
0226| 16) CLIENT-ERLEBNIS / AUTOMATISIERUNG (MUST)
0227| 16.1| Setup-Tool (ein Paket, MUST):
0228|     | - setzt NAT-T Registry-Key
0229|     | - richtet L2TP/IPsec Verbindung automatisch ein (rasphone.pbk/rasdial)
0230|     | - setzt NTP/Zeitstrategie
0231|     | - importiert CA in Windows Store (für systemweite Tools) + in MyPal NSS Store
0232|     | - erstellt Desktop-Shortcuts: Connect / Disconnect / Status / Diagnose
0233| 16.2| Redial/Keep-Alive (OPTIONAL, aber empfohlen):
0234|     | - Batch Loop mit rasdial (reconnect bei WLAN-Hickups)
0235|
0236| 16.3| Device Claim Token (MUST)
0237|     | - Pro Laptop/Connection wird ein Claim-Token erzeugt (DB speichert Hash).
0238|     | - Auf dem XP-Desktop liegt eine Datei (z.B. RETROWORK_AKTIVIERUNG.txt) mit:
0239|     |   * Claim Token (klar lesbar)
0240|     |   * URL: https://vpn.status
0241|     |   * Kurztext: "Wenn Internet gesperrt: Panel öffnen, registrieren, Token eingeben."
0242|     | - Zweck: Käufer kann Connection claimen, obwohl Name/Email/Passwort vorher unbekannt sind.
0243| 
0244| 17) DIAGNOSE-ENDPOINT (MUST, Supportkiller)
0245| 17.1| /diag (intern auf 10.77.0.1) liefert:
0246|     | - Your_IP (VPN IP)
0247|     | - DNS Check (Server resolvable)
0248|     | - Time Drift (grob)
0249|     | - Optional: Mini Throughput test / route check
0250| 17.2| Setup-Tool kann “Verbindung testen” Button haben (grün/rot).
0251|
0252| 18) EXPIRY / QUOTA / PORTAL MODE (MUST für Business)
0253| 18.1| Expiry:
0254|     | - Expiry Feld in DB pro Verbindung/Subaccount (keine chap-secrets Kommentare).
0255|     | - Nightly Job sperrt abgelaufene Verbindungen (Status=disabled).
0256| 18.2| Quota:
0257|     | - DB Felder: quota_total, quota_used, quota_reset_policy
0258|     | - Accounting liefert Bytes; Quota-Logik sperrt bei <=0.
0259| 18.3| Captive/Walled-Garden (OPTIONAL Feature, aber geplant):
0260|     | - Wenn expired/quota=0: nftables Policy pro User reduziert:
0261|       erlauben nur DNS + Zugriff auf 10.77.0.1 (Panel/Payment/Info).
0262|     | - Wichtig: bevorzugt IP-Policy (nft redirect), NICHT DNS-Vergiftung wegen TTL-Fallen.
0263| 18.4| Restricted Mode (Walled Garden) – MUST (Basis für Gate #1/#2)
0264|     | - Erlaubt im Restricted Mode NUR:
0265|     |   * DNS (TCP/UDP 53) -> 10.77.0.1
0266|     |   * HTTP/HTTPS (80/443) -> 10.77.0.1 (Panel/Status/Verify/Resend)
0267|     | - Alles andere: DROP (kein normales Internet)
0268| 
0269| 18.5| Gate #1 (CLAIM) – HARD (MUST)
0270|     | - Bedingung: now > trial_until UND status = PREPROVISIONED (customer_id ist NULL)
0271|     | - Aktion: Restricted Mode aktiv, bis Claim abgeschlossen
0272|     | - Claim bedeutet: Käufer registriert Panel-Account + gibt Claim-Token ein
0273|     | - Ergebnis: Connection wird CLAIMED (customer_id gesetzt) -> Internet sofort wieder frei
0274| 
0275| 18.6| Gate #2 (EMAIL VERIFY) – HARD (MUST)
0276|     | - Bedingung: now > verify_deadline UND email_verified_at ist NULL
0277|     | - Aktion: Restricted Mode aktiv, bis Email verifiziert
0278|     | - Hinweis: Internet-Freischaltung nach Claim bleibt bestehen bis Verify-Deadline abläuft
0279| 18.7| Scope Gate #2 (MUST-Entscheidung)
0280|     | - Gate #2 gilt kundenweit: wenn Customer nicht verifiziert, werden alle CLAIMED Connections
0281|     |   dieses Customers in Restricted Mode gehalten, bis verifiziert. 
0282|
0283| 19) SERVICE WATCHDOG / STABILITÄT (MUST)
0284| 19.1| systemd Auto-Restart:
0285|     | - strongSwan, xl2tpd, radius, openresty, php-fpm, mariadb, adguard/unbound
0286|     | - Restart=always, RestartSec=3 (über systemctl edit overrides)
0287| 19.2| Zusätzlich: Health Checks (OPTIONAL, später):
0288|     | - nicht nur “Prozess läuft”, sondern “Ports/Handshake ok”.
0289|
0290| 20) OFFLOAD-TUNING (VM) – DEFAULT (MUST)
0291| 20.1| Hintergrund:
0292|     | - VirtIO/VM Offloading kann “Phantom”-Packetloss/Checksum Issues erzeugen.
0293| 20.2| Policy:
0294|     | - Offload-Tuning als Default via systemd oneshot beim Boot.
0295| 20.3| Wichtig:
0296|     | - Wir tunen das reale NIC (ens13) und nur falls vorhanden/benötigt:
0297|       tso off, gso off, gro off (und gezielt checksum-offloads falls nötig).
0298|     | - Hinweis: “tap_soft” existiert in diesem Konzept NICHT (kein SoftEther TAP Mode).
0299| 20.4| Beispiel-Kommandos (Richtwert, final nach Test):
0300|     | - ethtool -K ens13 tso off gso off gro off
0301|     | - (optional) ethtool -K ens13 tx off rx off NUR wenn Tests zeigen, dass nötig
0302|
0303| 21) PHASENPLAN (MUST)
0304| Phase 1: VPN + AAA Stabil
0305| - Debian 13 minimal
0306| - strongSwan + xl2tpd + pppd
0307| - FreeRADIUS + SQL (Accounts/Subaccounts/Feste IPs/Accounting)
0308| - nftables: WAN minimal, 1701 nur via IPsec, Forward+NAT, Isolation, Outbound blocks
0309| - MSS Clamping aktiv
0310| - DPD + LCP Echo aktiv
0311| - Onboarding Gates (MUST): Gate #1 Claim (Trial->Restricted) + Gate #2 Verify (Deadline->Restricted)
0312| - Restricted Mode Policy (Walled Garden) ist in Phase 1 aktiv und getestet
0313| - Offload-Tuning Default
0314| - Tests: XP Einwahl NAT, Full-Tunnel, Reconnect, Logs sauber
0315|
0316| Phase 2: QoS aktiv
0317| - tc (CAKE/fq_codel) pro pppX via ip-up mit DB Parametern
0318| - Live-Drosselung testbar
0319|
0320| Phase 3: DNS Stack
0321| - Unbound lokal
0322| - AdGuardHome auf 10.77.0.1:53, UI 2000 admin-only
0323| - DNS Rewrite vpn.status -> 10.77.0.1
0324| - noch kein DNS-Zwang
0325|
0326| Phase 4: DNS-Zwang
0327| - DNAT 53 -> 10.77.0.1 (ppp*)
0328|
0329| Phase 5: Webpanel + MITM Blockpage “Premium”
0330| - OpenResty + PHP-FPM + MariaDB + phpMyAdmin intern
0331| - Panel: User Login mit IP-Abgleich + Reset via externem Mailserver
0332| - MyPal NSS Import Bundle
0333| - MITM Blockpage mit RateLimit + Cache
0334| - /diag Endpoint
0335|
0336| Phase 6 (optional): Captive/Walled-Garden + Quota/Payment UX
0337| - nft Policy “restricted mode” pro expired/quota
0338| - Panel Banner (Wartung/Infos)
0339|
0340| 22) STEALTH & SICHERHEIT (MUST)
0341| 22.1| WAN: nur IKE/NAT-T/ESP; sonst drop.
0342| 22.2| SSH: nur 127.0.0.1 + 10.77.0.1 gebunden; nft erlaubt SSH nur aus Admin-Netz.
0343| 22.3| User-Netz:
0344|     | - keine Admin-Services
0345|     | - Panel/Status ist erlaubt (bewusst), aber nur intern + IP-abgesichert
0346|     | - Peer-Isolation strikt
0347| 22.4| Admin-Netz:
0348|     | - darf Admin UIs (pma/adguard ui) und SSH, aber alles explizit freigeschaltet.
0349|
0350| ==================================================================================================
0351| ENDE MASTER-KONZEPT v1.8 (ZEILENFEST)
0352| ==================================================================================================
