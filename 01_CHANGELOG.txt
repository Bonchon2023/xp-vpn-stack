vpn_masterkonzept/01_CHANGELOG.txt
================================================================================
MASTER CHANGELOG
================================================================================
ERRATA (KANONISCHKEIT): Der Changelog kann historische Begriffe enthalten. Maßgeblich für den aktuellen Stand sind MASTER/Glossar/Blocks. Historische Begriffe sind nicht kanonisch.

- v2.1.1 (2026-01-08):
  - Terminologie kanonisiert: "Gate" aus kanonischen Texten/Titeln/Dateinamen entfernt (historische Changelog-Reste sind durch ERRATA entkanonisiert).
  - Onboarding kanonisiert: Verify-Wall (App-Layer, customer PENDING/ACTIVE) + Claim-Token (App-Layer) + UNCLAIMED Grace/Overdue (Kernel Restricted).
  - UNCLAIMED Grace (30 Tage) Startpunkt fixiert: ab Provisioning/Erstellung (auch ohne ersten Connect). Nach Ablauf -> restricted_reason=UNCLAIMED_OVERDUE -> "Nur Panel" (Walled Garden).
  - Hard-Stop/Leichen-Vermeidung: claim_deadline Feature bleibt OPTIONAL im Konzept, ist im Standardbetrieb aber IMMER gesetzt (180 Tage). Nach Ablauf (wenn weiterhin UNCLAIMED) -> status=DISABLED (HARD, kein VPN/kein Panel).
  - Admin-Actions kanonisiert:
    - Grace reset: setzt nur unclaimed_grace_until = NOW()+30d.
    - Deadline verlängern: setzt claim_deadline = NOW()+180d (Standard: neu setzen).
    - Re-enable / Re-provision nur solange Client existiert; Re-provision niemals für CLAIMED.
    - Claim-Token bleibt konstant pro VPN-Client.
  - UI/Wording: intern restricted/walled garden; Panel zeigt "Internet gesperrt" + "Nur Panel-Zugriff" + Grund-Mapping (Quota/Expiry/Manual/Unclaimed).
  - Renames: D008_VERIFY_WALL_CUSTOMER_SCOPE; B155_Onboarding_Verify-Wall_Claim_Token (Dateiname bereinigt).
  - DB/Schema-Alignment: vpn_connections um claim_deadline + status-Semantik erweitert; Reason/Flags konsistent gemacht.

v2.1.0 (2026-01-08)
- Master bump: v2.1.0
- Onboarding-Model aktualisiert:
  - Gate #1/#2 entfernt -> Verify-Wall + Claim-Token (B155)
  - Verify ist App-Layer (Panel UI), kein Kernel-Restricted-Trigger
  - UNCLAIMED Grace + UNCLAIMED_OVERDUE als Restricted-Quelle (Portal-Only) bis Claim/Grace-Reset
- Fix: Master-Dateien bereinigt (00_MASTER_* + 000_MASTER-*): verbliebene Gate#1/#2-Textreste entfernt; UNCLAIMED-Grace/UNCLAIMED_OVERDUE konsistent dokumentiert.
- Concurrency/Stability nachgezogen:
  - atomic SimUse-Guard via active_session_locks (DB-Schema in B055/B056)
  - vpn_connections.restricted_effective (indexed) für High-Perf Reconcile (B166)
- Service-IP Scopes: T06 abgelöst durch docs/nft_service_ip_scopes.txt; Referenzen in B120/B200/B210 konsolidiert
- Panel Security Model als eigener Block: B285_PANEL_SECURITY_MODEL.txt


- v2.1.0 (2026-01-07): Master-Konsolidierung (Tasks entfernt, Blocks kanonisch).
  - Neu/Kanonisiert:
    - B055_DB_SCHEMA_CORE.txt (vormals T01) als Block (SQL Schema-Core, inkl. active_session_locks).
    - B056_RADIUS_SCHEMA_MAPPING.txt (vormals T02) als Block (RADIUS<->SQL Mapping).
    - B285_PANEL_SECURITY_MODEL.txt als Block (Panel-AuthZ/Session/CSRF/Hardening Modell).
    - B310_TESTS_ACCEPTANCE_CATALOG.txt als Block (vormals T09 + Tests-Katalog).
    - B320_BACKUP_RESTORE_DR_RUNBOOK.txt als Block (vormals T14).
    - B330_LOGGING_MONITORING_RETENTION_ALERTS.txt als Block (vormals T15).
  - Entfernt aus der Doku-Struktur (Konzept bleibt enthalten, aber nicht mehr als Tasks):
    - tasks/T/… (T01–T15) wird als Ordner nicht mehr benötigt, da Inhalte in Blocks/Docs/Decisions gespiegelt sind.
  - Doku/Index aktualisiert:
    - 04_BLOCK_INDEX.txt auf Master v2.1.0 aktualisiert (inkl. B285 + B055/B056 + B310/B320/B330).
    - 00000_Ordnerstrucktur.txt aktualisiert (Tasks/T als optional/legacy markiert).
    - README.md + 0000_Erklärung.txt aktualisiert (Tasks-Entfernung + Legacy-Hinweise).
  - nft Service-IP Scopes:
    - docs/nft_service_ip_scopes.txt bleibt kanonisch (T06 bleibt entfernt).

v2.0.1
- Klarstellung (Scope/Ehrlichkeit): DNS-Zwang per DNAT53 erzwingt klassisches DNS (Port 53, TCP+UDP).
  DoH/DoT wird in dieser Runde bewusst nicht behandelt (PARKED). Keine funktionale Änderung am Konzept, nur Präzisierung.

v2.0
- KERN-ÄNDERUNG: DNS-ZWANG ist jetzt IMMER aktiv (MUST): DNAT TCP+UDP 53 von iif ppp* -> 10.77.0.1:53 (B210 auf MUST umgestellt).
- KERN-ÄNDERUNG: Policy-Enforcement ist jetzt deterministisch und “operativ geschlossen”:
  - B166 Policy Apply + Reconcile (DRY Tool, Exitcodes, FLUSH+REBUILD restricted_v4; Drift-Schutz <=5min).
  - B167 Wiring (ip-up/ip-down Runtime-Mapping /run/vpn-sessions/pppX.env, Boot-Reconcile, systemd timer/services).
- NEU: Accounting Collector / Session Mapping als eigenes, verbindliches Modul (B165):
  - pppX -> connection_id Mapping (run-state) + durable spool für DB-Down; batchweise Deltas (kein DB-Spam).
- KERN-ÄNDERUNG: Simultaneous-Use=1 ist jetzt “Produkt-hart” und Lockout-sicher gelöst:
  - B168 Stale Session Janitor (Interim 300s, Threshold 900s, Safety Check gegen /run/vpn-sessions).
  - B169 RADIUS Login Flow mit On-demand Janitor + 2-step Retry (RateLimit/Cache/Timeout).
- SCHÄRFUNG: SQL/AAA/Policy ist jetzt konsequent “Fail-Closed” bei DB-Down (kein Break-Glass über VPN).
- SCHÄRFUNG: Walled Garden/Restricted ist jetzt kanonisch und vollständig definiert:
  - B150 Allowlist im Restricted Mode (nur DNS/HTTP/HTTPS/NTP zu 10.77.0.1, optional ICMP zu 10.77.0.1).
  - Reihenfolge im Forward-Pfad fest: established -> Peer-Isolation -> Restricted -> normal Forward Allow.
- SCHÄRFUNG: Gate #2 (Email Verify) ist jetzt als Decision explizit fixiert und kundenweit bindend (D008):
  - ohne Verify bleiben ALLE claimed Connections des Customers im Restricted Mode bis verifiziert.
- UPDATE: B050 SQL AAA / FreeRADIUS / Accounting erweitert (Restricted statt Reject, restricted_reason, Stale-Handling, Onboarding-Felder).
- UPDATE: nft Blöcke auf v2.0-Order und Konsistenz gehärtet (B120 Forward/NAT, B130 Peer Isolation, B150 Restricted/Walled Garden).
- UPDATE: Panel ist mit Policy-Apply gekoppelt (B280): Statusänderungen müssen vpn-policy-apply triggern, Reconcile bleibt Safety-Net.

v1.8
- NEU: B155 Onboarding Gates (Gate#1 Claim + Gate#2 Email Verify) als eigener Block (State Machine / Deadlines / Enforcement).
- Änderung: Walled Garden ist jetzt HARD (Basis-Policy für Gate#1+Gate#2 + später Quota/Expiry) und nicht mehr nur "Premium vorbereitet".
- Konsistenz: Master/Dependencies/Decisions angepasst (B155 eingehängt: B050/B150/B280/B220; Setup-Tool B240 -> B155).
- Klarstellung: Gate #2 ist hart: nach verify_deadline ohne Email-Verify -> wieder Walled Garden bis verifiziert (kundenweit).

v1.7
- Konsolidiert: SQL-first AAA ab Tag 1 (FreeRADIUS+SQL, Accounting Pflicht).
- Klarstellung: "User dürfen keine Services" ersetzt durch definierte User-Services:
  Panel/Status/Portal/Blockpage sind erlaubt, Admin-Services nicht.
- Entscheidung: OpenResty als einziger Web-Frontend (Panel + MITM + PHP-FPM).
- Pflicht: NTP Strategie (Pre-Connect Zeitfix + Post-Connect NTP auf 10.77.0.1).
- Pflicht: XP NAT-T Registry Fix (AssumeUDPEncapsulationContextOnSendRule=2).
- Pflicht: MSS/MTU Stabilisierung (MSS clamping).
- Pflicht: Outbound Abuse Blocks (SMTP/SMB/NetBIOS).
- Default: VM Offload-Tuning auf ens13 persistent.
- Premium: Walled Garden Quota/Expiry vorbereitet.
- Premium: Diagnose-Endpoint /diag vorbereitet.

v1.6
- NTP ergänzt, MyPal NSS Import detailliert, Offload-Tuning als Default-Baseline.

v1.5
- SQL-first Richtung festgezurrt, Webpanel intern, Blockpage MITM geplant.

================================================================================
ENDE 01_CHANGELOG.txt
================================================================================